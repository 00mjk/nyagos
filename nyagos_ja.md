# NYAGOS - Nihongo Yet Another GOing Shell

NYAGOS は、go言語による Windows 用コマンドラインシェルです。
Nihongo とありますが、Unicode ベースなので、特に特定の自然言語に
特化しているわけではありません。

NYAGOS は、Windows の文化を尊重しつつ、UNIX に慣れた人が、
Windows であまりストレスを感じないような環境を構築するために
開発されているシェルです。bash など特定のシェルの互換を目指す
ものではありません。

特徴

* 現在のコードページに関わらず、JISに未登録の Unicode も扱えます。
   * クリップボードにある Unicode 文字のペースト・編集可能
   * 直接入力できずとも %U+XXXX% というリテラルで変換可能
   * プロンプトにも $Uxxxx というマクロが使用可能
* 高機能内蔵 ls
   * カラー表示(-o オプション)
   * ジャンクションを区別可能(-F オプションで「@」がファイル名末尾につく)
* UNIXライクなシェル機能
   * ヒストリ機能(Ctrl-P や ! 文字による置換)
   * エイリアス
   * ファイル名・コマンド名補完
* Lua言語を使ったカスタマイズ機能
   * Lua で内蔵コマンドを作成可能
   * 入力文字列を Lua で加工できる
   * コードページ文字列⇔UTF8変換関数や、eval関数などの支援関数も用意

## インストール

`nyagos.exe` 、`nyagos.lua`、`lua52.dll` を `%PATH%` の差す
ディレクトリに置いてください(同一のディレクトリに置いてください)。

カスタマイズ用ファイル `.nyagos` は、`%USERPROFILE%` か `%HOME%`
の差すディレクトリに置いて、必要に応じて修正してください。

## 起動オプション

### `-c "コマンド"`

コマンドを実行して、ただちに終了します。

### `-k "コマンド"`

コマンドを実行してから、通常起動します。

## 編集機能

UNIX系シェルに近いキーバインドで、コマンドラインを編集可能です。

* BackSpace , Ctrl-H : カーソル左の一文字を削除
* Enter , Ctrl-M     : 入力終結
* Del                : カーソル上の一文字を削除
* Home , Ctrl-A      : カーソルを先頭へ移動
* ← , Ctrl-B        : カーソルを一文字左へ移動
* Ctrl-D             : 0文字の時は NYAGOS を終了、さもなければ Del と同じ
* End , Ctrl-E       : カーソルを末尾へ移動
* → , Ctrl-F        : カーソルを一文字右へ移動
* Ctrl-K             : カーソル以降の文字を全て削除し、クリップボードへコピー
* Ctrl-L             : 画面をクリアして、入力した内容を再表示
* Ctrl-U             : カーソルまでの文字を全て削除し、クリップボードへコピー
* Ctrl-Y             : クリップボードの内容を貼り付ける
* Esc , Ctrl-[       : 入力内容を全て削除する
* ↑ , Ctrl-P        : ヒストリ：一つ前の入力内容を展開する
* ↓ , Ctrl-N        : ヒストリ：一つ後の入力内容を展開する
* TAB , Ctrl-I       : ファイル名・コマンド名補完

## 内蔵コマンド

### `alias エイリアス名=定義`

エイリアスを設定します。置換内容には以下のマクロが使えます。

* `$n` (n:数字) n番目の引数となります
* `$*` 全ての引数に置換されます。

置換内容が空の時はエイリアスを削除します。
= が無い場合は、その名前のエイリアスの内容を表示します。
引数が無い場合は、全エイリアスを一覧します。

### `cd ドライブ:ディレクトリ`

現在のカレントドライブ、ディレクトリを変更します。
引数を省略すると、CMD.EXE と違い、環境変数 HOME 、あるいは 
USERPROFILE の差す先のディレクトリへ移動します。
CMD.EXE と違い、ドライブも同時に変更します。

### `exit`

NYAGOS を終了します。

### `history [件数]`

ヒストリ内容を表示します。件数を省略すると、最近の10件が表示されます。

### `ls [-オプション] …`

ディレクトリの一覧を表示します。
サポートしているオプションは以下の通りです。

* `-l` ロングフォーマットで一覧を表示します。
* `-F` ディレクトリ名の末尾に /  を、実行ファイル名の末尾に * を表示します。
* `-o` カラー化します
* `-a` . で始まるファイルも表示します。
* `-R` サブディレクトリ以下も表示します。

### `pwd`

現在のカレントドライブ + ディレクトリを表示します。

### `set 変数名=値`

環境変数に値を設定します。値に空白等を含む場合、CMD.EXE と同様に
「`set "変数名=値"`」とします。= 以降を省略すると、現在の変数の内容を
表示します。

以下の変数は特別な意味を持ちます。

* `PROMPT` … プロンプトの文字列を設定します。`$P` 等のマクロ文字はCMD.EXE と同じです。shiena 様開発のモジュールによりエスケープシーケンスが使えます。

### `source バッチファイル名`

バッチファイルを実行します。CMD.EXE を使って実行しているので、
バッチファイル内で NYAGOS 内蔵コマンドを使うことは出来ませんが、
バッチファイルで変更された環境変数を NYAGOS 側へ取り込むことが
できます (NYAOS 3 の cmdsource 相当です)
コマンド名として「`source`」の代わりに「`.`」(ドット)一文字も使う
ことができます。

### `lua_e "luaコマンド"`

lua のコマンドをインラインで実行します。
本コマンドは nyagos.lua で定義された Lua 関数が実体です。

## 起動処理

1. 起動時に nyagos.exe と同じフォルダの nyagos.lua を読み込みます。nyagos.lua はLua で記述されており、ここから更にホームディレクトリ(%HOME% or %USERPROFILE%)の .nyagos の Lua コードを読み込みます(nyagos拡張は後述)。ユーザカスタマイズは、この .nyagos を編集して行うことができます。
2. 過去のヒストリ内容を `%APPDATA%\NYAOS_ORG\nyagos.history` から読み出します。NYAGOS 終了時には、このファイルに再び最後のヒストリ内容が書き出されます。

## コマンドライン置換

### ヒストリ置換

* `!!`  一つ前の入力文字列へ
* `!n`  最初から n 番目に入力文字列へ
* `!-n` n 個前に入力した文字列へ

以下のような語尾をつけることができます。

* `:0` コマンド名を引用する。
* `:m` m 番目の引数だけを引用する。
* `^`  最初の引数だけを抜き出す。
* `$`  最後の引数だけを抜き出す。
* `*`  全ての引数を引用する。

### 環境変数置換

* コマンドや引数先頭の `~` を `%HOME%` あるいは `%USERPROFILE%` に置換します。

### Unicode リテラル

* `%u+XXXX%` (XXXX:16進数) を Unicode 文字に置換します。

## Lua拡張

nyagos では、EXE の本体の機能はコンパクトとし、便利機能は 
なるべく Lua で機能を拡張できるよう設計を進めています。
現在は以下のような関数が使用できます。

### `nyagos.alias("エイリアス名","置換コード")`

エイリアスを設定します。nyagos.lua 内で、これを簡略した

* `alias "エイリアス名=置換コード"`
* `alias{ エイリアス名="置換コード" , エイリアス名="置換コード" … }`

が定義されています(Lua は引数が一つの場合は括弧を省略できます)。
置換コードでは「alias」コマンドと同様、`$1` や `$*` などのマクロが
使用可能です。

### `nyagos.setenv("環境変数名","変数内容")`

環境変数を設定します。nyagos.lua 内で、これを簡略した

* `set "変数名=定義内容"`
* `set "変数名+=追加定義"`
* `set{ 変数名="定義内容" , 変数名="定義内容"}`

が定義されています(Lua は引数が一つの場合は括弧を省略できます)。
`set` は `nyagos.setenv` の処理に %変数名% の展開機能なども
組込まれています。

### `nyagos.exec("シェルコマンド")`

シェルコマンドを実行します。標準 nyagos.lua では、これの別名として

* `x'シェルコマンド'`

を定義しています。

### `nyagos.eval("シェルコマンド")`

nyagos.exec と同じですが、標準出力を取り込んで、戻り値として返します。
実行に失敗した場合などは nil が戻ります。

### `nyagos.write(テキスト)`

テキストを出力しますが、リダイレクトされている場合は文字コードは
UTF8 になります。内蔵 Lua の print は nyagos.write(テキスト..'\n')
に差し替えられています。

### `nyagos.getwd()`

現在のカレントディレクトリを返します。

### `nyagos.utoa(UTF8文字列)`

UTF8文字列を、現在のコードページの文字列に変換します。

### `nyagos.atou(ANSI文字列)`

現在のコードページの文字列を、UTF8 へ変換します。

### `nyagos.glob(ワイルドカード文字列)`

ワイルドカードを展開して、格納したテーブルを返します。

### `nyagos.bindkey("キー名","機能名")`

一行入力のキーに機能を割り当てます。

キー名として以下が使えます。

	"BACKSPACE" "CTRL" "C_A" "C_B" "C_C" "C_D" "C_E" "C_F" "C_G" "C_H"
	"C_I" "C_J" "C_K" "C_L" "C_M" "C_N" "C_O" "C_P" "C_Q" "C_R" "C_S"
	"C_T" "C_U" "C_V" "C_W" "C_X" "C_Y" "C_Z" "DEL" "DOWN" "END"
	"ENTER" "ESCAPE" "HOME" "LEFT" "RIGHT" "SHIFT" "UP"

機能名として以下が使えます。

	"BACKSPACE" "BACKWORD" "CLEAR" "DELETE" "DELETE_OR_ABORT"
	"ENTER" "ERASEAFTER" "ERASEBEFORE" "FORWARD" "HEAD"
	"PASS" "PASTE" "REPAINT" "TAIL" "HISTORY_UP" "HISTORY_DOWN"
        "COMPLETE"

成功すると true を、失敗すると nil とエラーメッセージを返します。

### `nyagos.filter`

通常ユーザが呼び出すことはありません。
当関数を定義すると、ユーザが入力したコマンドラインの内容を引数として
NYAGOS.EXE から呼び出されます。これを加工して戻り値とすると、
NYAGOS.EXE はコマンドラインを、その文字列と置き換えます。

標準の nyagos.lua では nyagos.filter には、逆クォート機能を実現する関数が
定義されています。処理内容としては nyagos.eval でコマンドの出力を取り込み、
nyagos.atou で UTF8 に変換して、NYAGOS.EXE に返しています。

### `nyagos.argsfilter`

nyagos.argsfilter は nyagos.filter と似ていますが、コマンドライン
を字句解析した後の、引数配列(args)を加工できる点が違います。

標準の nyagos.lua では nyagos.argsfilter を使って、
suffix というコマンドを作成しています。

    コマンド
        suffix 拡張子 インタプリタ名 引数1 引数2 …
    Lua:関数
        suffix("拡張子",{"インタプリタ名","引数1"…})

これはコマンドに特定の拡張子がついた時に、インタプリタ名を
先頭に挿入するものです。

### `nyagos.exe`

nyagos.exe のフルパスが格納されています。

## その他

NYAGOS のソースは https://github.com/zetamatta/nyagos にて、
バイナリパッケージは http://www.nyaos.org/index.cgi?p=NYAGOS にて、
公開しています。ソースは、修正BSDライセンスにて配布・改変が可能です。

NYAGOS のビルドには

- [go1.3.3 for windows/386](http://golang.org)
- [Mingw-Gcc 4.8.1-4](http://mingw.org/)
- [LuaBinaries 5.2.3 for Win32 and MinGW](http://luabinaries.sourceforge.net/index.html)

が必要となります。言語標準以外では、以下のモジュールを
利用させていただいております。

- http://github.com/mattn/go-runewidth
- http://github.com/shiena/ansicolor
- http://github.com/atotto/clipboard

以上
